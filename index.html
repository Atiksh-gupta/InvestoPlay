
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>InvestoPlay ‚Äî Dummy Investment Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- Base ---------- */
    :root{
      --bg:#f7f9fc;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#0366d6;
      --accent:#00b4d8;
      --success:#16a34a;
      --danger:#dc3545;
      --glass: rgba(255,255,255,0.7);
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --radius:12px;
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg), #eef4fb);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }
body.dark{ 
--bg:#0f172a; 
--card:#1e293b; 
--muted:#94a3b8; 
--primary:#38bdf8; 
--accent:#22d3ee; 
--success:#4ade80; 
--danger:#f87171; 
background:var(--bg); color:white;
}
    header{
      background: linear-gradient(90deg,var(--primary), var(--accent));
      color: white;
      padding:28px 20px;
      text-align:center;
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:10;
    }
    header .title{ font-size:20px; font-weight:700; letter-spacing:0.6px; }
    .container{ max-width:var(--maxw); margin:28px auto; padding:0 18px; }

    /* ---------- Login Card ---------- */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }
    #loginSection{ max-width:420px; margin:52px auto; }
    .form-row{ margin:12px 0; }
    input[type="text"], input[type="password"], input[type="number"]{
      width:100%;
      padding:12px 14px;
      border-radius:8px;
      border:1px solid #e6edf3;
      background:#fbfdff;
      font-size:15px;
    }
    button.btn{
      display:inline-block;
      padding:10px 14px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary{ background:var(--primary); color:white; }
    .btn-ghost{ background:transparent; border:1px solid #dbeafe; color:var(--primary); }
    .muted{ color:var(--muted); font-size:14px; }

    /* ---------- App layout ---------- */
    #appSection{ display:none; }
    nav#stockTabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:18px; }
    nav#stockTabs button{ padding:10px 14px; border-radius:10px; border:0; cursor:pointer; background:#eef7ff; color:var(--primary); font-weight:600; box-shadow: 0 2px 6px rgba(3,102,214,0.06); }
    nav#stockTabs button.active{ background:linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow: 0 8px 26px rgba(3,102,214,0.14); transform:translateY(-2px); }

    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      max-width:var(--maxw);
      margin:0 auto;
    }

    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    #balance{
      font-size:18px; font-weight:700; color:#0f172a;
      background:linear-gradient(90deg,#ffffff, #f8fbff);
      padding:10px 14px; border-radius:10px;
      box-shadow: 0 4px 10px rgba(2,6,23,0.04);
    }

    /* ---------- Tab card ---------- */
    .tab{ display:none; padding:18px; border-radius:12px; background:var(--card); box-shadow:var(--shadow); }
    .stock-head{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .stock-head h2{ margin:0; color:var(--primary); font-size:18px; }
    .stockInfo{ margin-top:12px; padding:12px; border-radius:10px; background:#f6fbff; border:1px solid #e6f0ff; color:#05264c; }
    .positions-list{ margin:8px 0 0 0; padding-left:16px; color: #062a45; }
    .small-note{ font-size:13px; color:var(--muted); margin-top:8px; }

    .stockActions{ display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .stockActions input{ width:92px; }

    /* ---------- Portfolio table ---------- */
    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    table th, table td{ text-align:left; padding:10px; border-bottom:1px solid #eef2f7; }
    table th{ color:var(--muted); font-weight:600; background:#fbfdff; border-bottom: 2px solid #eef2f7; }
    .pl-positive{ color:var(--success); font-weight:700; }
    .pl-negative{ color:var(--danger); font-weight:700; }

    /* ---------- Admin UI ---------- */
    .admin-controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .admin-panel-grid{ display:grid; grid-template-columns:1fr 360px; gap:18px; }
    .user-list{ max-height:400px; overflow:auto; padding:8px; border-radius:10px; background:#fbfdff; border:1px solid #eef4fb; }
    .user-item{ padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; background:white; box-shadow:0 2px 6px rgba(2,6,23,0.03); }
    .user-item .meta{ font-size:14px; color:#07203a; }
    .user-actions button{ margin-left:6px; }

    /* ---------- Responsive ---------- */
    @media (min-width:900px){
      .layout{ grid-template-columns: 1fr; }
      .admin-panel-grid{ grid-template-columns: 1fr 420px; }
    }
    @media (max-width:520px){
      .stockActions input{ width:70px; }
      input[type="text"], input[type="password"]{ font-size:14px; }
    }
 #welcomePage {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(120deg, #007bff, #00b4d8);
      color: white;
      text-align: center;
      animation: fadeIn 1.5s ease;
    }
    #welcomePage h1 {
      font-size: 48px;
      margin-bottom: 20px;
      animation: slideDown 1.2s ease;
    }
    #welcomePage h2 {
      font-size: 24px;
      font-weight: 400;
      margin-bottom: 30px;
      animation: slideUp 1.2s ease;
    }
    #welcomePage button {
      padding: 12px 28px;
      border: none;
      border-radius: 6px;
      background: #fff;
      color: #007bff;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    #welcomePage button:hover {
      background: #e2e8f0;
    }

    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes slideDown { from {transform:translateY(-40px);opacity:0;} to {transform:translateY(0);opacity:1;} }
    @keyframes slideUp { from {transform:translateY(40px);opacity:0;} to {transform:translateY(0);opacity:1;} }
  </style>
</head>
<body>
  <header>
    <div class="title">InvestoPlay ‚Äî Dummy Investment Simulator</div>
  </header>

  <div id="welcomePage">
    <h1>Welcome to InvestoPlay</h1>
    <h2>Powered by WEB BUILDERS</h2>
    <button onclick="enterSite()">Enter</button>
  </div>

  <div class="container">

    <!-- LOGIN -->
    <div id="loginSection" class="card">
      <h2 style="margin:0 0 12px 0; color:#05264c">Login / Signup</h2>
      <div class="form-row">
        <input id="username" type="text" placeholder="Username" />
      </div>
      <div class="form-row">
        <input id="password" type="password" placeholder="Password" />
      </div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
        <button class="btn btn-primary" onclick="signup()">Signup</button>
        <button class="btn btn-ghost" onclick="login()">Login</button>
      </div>
      <p id="loginMsg" class="muted" style="text-align:center; margin-top:10px;"></p>
    </div>

    <!-- APP -->
    <div id="appSection" style="display:none;">
      <div class="header-row" style="align-items:center;">
        <div id="balance">Balance: ‚Çπ10000</div>
        <div style="display:flex; gap:10px;">
        <button class="btn btn-ghost" onclick="toggleTheme()">üåì</button>
        <button class="btn btn-ghost" onclick="logout()">Logout</button>
        </div>
      </div>

      <nav id="stockTabs" aria-label="Stocks tabs"></nav>

      <div id="stockContainers" class="layout"></div>

      <!-- portfolio tab -->
      <div id="portfolio" class="tab card"></div>
      <h2>Portfolio Overview</h2>
      <table id="portfolioTable">
        <thead>
          <tr>
            <th>Stock</th>
            <th>Qty</th>
            <th>Avg Price</th>
            <th>Current</th>
            <th>P/L</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small-note">Your profits/losses are updated in real-time based on stock prices.</p>
    </div>

      <!-- admin tab -->
      <div id="adminPanel" class="tab card"></div>

    <!-- Chart Tab -->
    <div id="charts" class="tab card">
      <h2>Stock Charts</h2>
      <canvas id="stockChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>


<script>
/* ========== App State ========== */
let users = JSON.parse(localStorage.getItem("users")) || {};
let currentUser = null;
let balance = 10000;
let stocks = {};             // market stocks keyed by name: { price, positions:[], history:[] }
let charts = {};
// default market list
let stockList = ["TechNova","GreenEnergy","FoodiesHub","AeroMax","CryptoWave","HealthFirst","EduGrow","GameX","RoboWorks","AutoDrive","FashionFi","BuildPro"];
let newsHeadlines = ["launches new product","faces regulations","profits surge","merger rumors","stock buyback announced"];
let darkMode = false;

function enterSite(){
  document.getElementById("welcomePage").style.display="none";
  document.querySelector("header").style.display="block";
  document.getElementById("loginSection").style.display="block";
}

/* ---------- Helpers ---------- */
function saveAll(){
  if(currentUser && currentUser !== "admin"){
    users[currentUser].balance = balance;
    users[currentUser].portfolio = stocks;
  }
  localStorage.setItem("users", JSON.stringify(users));
}
function formatR(n){ return "‚Çπ" + parseFloat(n).toFixed(2); }

/* ---------- Auth ---------- */
function signup(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if(!u||!p){ alert("Enter username & password"); return; }
  if(users[u]){ alert("User exists"); return; }
  users[u] = { password: p, balance: 10000, portfolio: {} };
  localStorage.setItem("users", JSON.stringify(users));
  alert("Signup successful ‚Äî now login.");
}
function login(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if(u === "admin" && p === "admin123"){
    currentUser = "admin";
    showApp();
    return;
  }
  if(!users[u] || users[u].password !== p){
    document.getElementById("loginMsg").innerText = "Invalid login";
    return;
  }
  currentUser = u;
  balance = users[u].balance || 10000;
  // clone portfolio into working stocks so the UI displays it
  stocks = users[u].portfolio || {};
  // ensure all market stocks exist in stocks object
  stockList.forEach(s => {
    if(!stocks[s]) stocks[s] = { price: 1000 + Math.random()*200, positions: [], history: [] };
  });
  showApp();
}
function logout(){
  currentUser = null;
  balance = 10000;
  stocks = {};
  charts = {};
  document.getElementById("appSection").style.display = "none";
  document.getElementById("loginSection").style.display = "block";
  document.getElementById("loginMsg").innerText = "";
}


function updatePortfolio(){
  const tbody = document.querySelector('#portfolioTable tbody');
  tbody.innerHTML='';
  for(const key in portfolio){
    const s = stocks.find(st=>st.name===key);
    const pl = (s.price-portfolio[key].avg)*portfolio[key].qty;
    const row = `<tr>
      <td>${key}</td>
      <td>${portfolio[key].qty}</td>
      <td>‚Çπ${portfolio[key].avg.toFixed(2)}</td>
      <td>‚Çπ${s.price.toFixed(2)}</td>
      <td class="${pl>=0?'pl-positive':'pl-negative'}">‚Çπ${pl.toFixed(2)}</td>
    </tr>`;
    tbody.innerHTML+=row;
  }
}

// ======== CHART ========
const ctx = document.getElementById('stockChart').getContext('2d');
const chart = new Chart(ctx,{
  type:'line',
  data:{ labels:[], datasets:[] },
  options:{ responsive:true, plugins:{ legend:{display:true} } }
});
function updateChart(){
  chart.data.labels = stocks.map(s=>s.name);
  chart.data.datasets = [{ label:'Current Price', data:stocks.map(s=>s.price), borderColor:'#007bff', backgroundColor:'rgba(0,123,255,0.2)' }];
  chart.update();
}

// ======== THEME ========
function toggleTheme(){ 
  darkMode=!darkMode; 
  document.body.classList.toggle('dark', darkMode); 
}

window.onload = () => {
  darkMode = localStorage.getItem('darkMode') === 'true';
  document.body.classList.toggle('dark', darkMode);
};
function toggleTheme(){ 
  darkMode = !darkMode; 
  document.body.classList.toggle('dark', darkMode); 
  localStorage.setItem('darkMode', darkMode);
}

function createStockContainer(stock){
  const container = document.getElementById('stockContainers');
  const div = document.createElement('div');
  div.id = stock.name;
  div.className='tab card';
  div.innerHTML = `
    <div class="stock-head"><h2>${stock.name}</h2><span>‚Çπ${stock.price}</span></div>
    <div class="stockActions">
      <input type="number" id="buyQty_${stock.name}" placeholder="Qty">
      <button class="btn btn-primary" onclick="buyStock('${stock.name}')">Buy</button>
      <input type="number" id="sellQty_${stock.name}" placeholder="Qty">
      <button class="btn btn-danger" onclick="sellStock('${stock.name}')">Sell</button>
    </div>
  `;
  container.appendChild(div);
}

/* ---------- UI boot ---------- */
function showApp(){
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("appSection").style.display = "block";
  initMarketIfNeeded();
  buildTabs();
  updateBalanceUI();
  loadStocksUI();
  // timers
  clearIntervals();
  window._updatePricesInterval = setInterval(updatePrices, 5000);
  window._randomEventsInterval = setInterval(randomEvents, 7000);
  window._dividendsInterval = setInterval(giveDividends, 15000);
}
function initMarketIfNeeded(){
  // if stocks empty, initialize market skeleton from stockList
  stockList.forEach(s => {
    if(!stocks[s]) stocks[s] = { price: 1000 + Math.random()*200, positions: [], history: [] };
    stocks[s].positions = stocks[s].positions || [];
    stocks[s].history = stocks[s].history || [];
    stocks[s].price = stocks[s].price || 1000 + Math.random()*200;
  });
}

function clearIntervals(){
  if(window._updatePricesInterval) clearInterval(window._updatePricesInterval);
  if(window._randomEventsInterval) clearInterval(window._randomEventsInterval);
  if(window._dividendsInterval) clearInterval(window._dividendsInterval);
}

/* ---------- Tabs & Market UI ---------- */
function buildTabs(){
  const tabs = document.getElementById("stockTabs");
  tabs.innerHTML = "";
  // portfolio tab
  const portBtn = document.createElement("button");
  portBtn.innerText = "üìä Portfolio";
  portBtn.onclick = () => showTab("portfolio");
  tabs.appendChild(portBtn);

  // admin tab (only for admin)
  if(currentUser === "admin"){
    const adminBtn = document.createElement("button");
    adminBtn.innerText = "‚öôÔ∏è Admin Panel";
    adminBtn.onclick = () => showTab("adminPanel");
    tabs.appendChild(adminBtn);
  }

  // per-stock tabs
  stockList.forEach(s => {
    const b = document.createElement("button");
    b.innerText = s;
    b.onclick = () => showTab(s);
    tabs.appendChild(b);
  });
  // mark first as active initially
  const first = tabs.querySelector("button");
  if(first) first.classList.add("active");
}

function showTab(tab){
  // highlight active
  document.querySelectorAll("#stockTabs button").forEach(b => b.classList.remove("active"));
  const btn = Array.from(document.querySelectorAll("#stockTabs button")).find(x=>x.innerText===tab || (tab==="portfolio" && x.innerText.includes("Portfolio")) || (tab==="adminPanel" && x.innerText.includes("Admin")));
  if(btn) btn.classList.add("active");

  // hide all tabs
  document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
  // show or build
  if(tab === "portfolio") {
    buildPortfolioTab();
    document.getElementById("portfolio").style.display = "block";
  } else if(tab === "adminPanel") {
    buildAdminPanel();
    document.getElementById("adminPanel").style.display = "block";
  } else {
    // stock tab
    const el = document.getElementById(tab);
    if(!el) {
      // build if missing
      buildSingleStockTab(tab);
    }
    document.getElementById(tab).style.display = "block";
  }
}

/* ---------- Build stock tabs ---------- */
function loadStocksUI(){
  const container = document.getElementById("stockContainers");
  container.innerHTML = "";
  stockList.forEach(s => buildSingleStockTab(s));
  // show first stock by default
  if(stockList[0]) showTab(stockList[0]);
}

function buildSingleStockTab(stockName){
  const container = document.getElementById("stockContainers");
  // remove existing tab element if present
  let existing = document.getElementById(stockName);
  if(existing) existing.remove();

  const tab = document.createElement("div");
  tab.className = "tab card";
  tab.id = stockName;

  tab.innerHTML = `
    <div class="stock-head">
      <div>
        <h2>${stockName}</h2>
        <div class="small-note">Market instrument &mdash; simulated</div>
      </div>
      <div style="min-width:200px; text-align:right;">
        <div style="font-weight:700; font-size:16px;" id="price-${stockName}">${formatR(stocks[stockName].price)}</div>
        <div class="muted small-note" id="last-updated-${stockName}">Live</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <canvas id="chart-${stockName}" style="max-height:220px;"></canvas>
    </div>

    <div class="stockInfo" id="info-${stockName}"></div>

    <div class="stockActions" style="margin-top:10px;">
      <input id="qty-${stockName}" type="number" min="1" value="1" />
      <button class="btn btn-primary" onclick="buyStock('${stockName}')">Buy</button>
      <button class="btn" style="background:var(--danger); color:white;" onclick="sellStock('${stockName}')">Sell</button>
      <div style="flex:1"></div>
      <div class="muted small-note">Tip: positions are listed separately (no averaging).</div>
    </div>
  `;

  container.appendChild(tab);

  // initialize chart
  const ctx = tab.querySelector(`#chart-${stockName}`);
  const c = new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [{ label: stockName, data: [], borderColor: '#0b74ff', borderWidth:2, fill:false, pointRadius:0 }] },
    options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{beginAtZero:false}}}
  });
  charts[stockName] = c;
  // populate initial chart history if any
  const h = stocks[stockName].history || [];
  if(h.length){
    c.data.labels = h.map((_,i)=>i+1);
    c.data.datasets[0].data = h.map(v=>parseFloat(v));
    c.update();
  }
  updateStockInfo(stockName);
}

/* ---------- Price updates & events ---------- */
function updatePrices(){
  stockList.forEach(s=>{
    const change = (Math.random()-0.5)*100;
    stocks[s].price = Math.max(50, stocks[s].price + change);
    stocks[s].history.push(parseFloat(stocks[s].price.toFixed(2)));
    if(stocks[s].history.length > 30) stocks[s].history.shift();

    // update chart
    const chart = charts[s];
    if(chart){
      chart.data.labels = stocks[s].history.map((_,i)=>"");
      chart.data.datasets[0].data = stocks[s].history;
      chart.data.datasets[0].borderColor = change >= 0 ? '#16a34a' : '#dc2626';
      chart.update();
    }
    // update price and stock info area
    const priceEl = document.getElementById(`price-${s}`);
    if(priceEl) priceEl.innerText = formatR(stocks[s].price);
    updateStockInfo(s);
  });
  saveAll();
}

function randomEvents(){
  if(Math.random() < 0.22){
    const st = stockList[Math.floor(Math.random()*stockList.length)];
    const boom = Math.random() < 0.5;
    stocks[st].price = Math.max(50, stocks[st].price * (boom ? 1.28 : 0.72));
    alert(boom ? `üöÄ ${st} skyrocketed!` : `‚ö†Ô∏è ${st} had a sharp fall!`);
    updatePrices(); // immediate apply
  }
}

/* ---------- Buy / Sell (positions preserved) ---------- */
function buyStock(st){
  const qty = Math.max(1, parseInt(document.getElementById(`qty-${st}`).value || 1));
  const total = stocks[st].price * qty;
  if(currentUser === "admin"){ alert("Admin cannot buy. Use admin panel to modify user portfolios."); return; }
  if(balance < total){ alert("Not enough funds"); return; }
  if(!confirm(`Buy ${qty} √ó ${st} for ${formatR(total)}?`)) return;
  balance -= total;
  // push position: keep separate buys
  stocks[st].positions.push({ qty: qty, price: parseFloat(stocks[st].price.toFixed(2)) });
  updateBalanceUI();
  updateStockInfo(st);
  saveAll();
}
function sellStock(st){
  const qty = Math.max(1, parseInt(document.getElementById(`qty-${st}`).value || 1));
  if(currentUser === "admin"){ alert("Admin cannot sell. Use admin panel to modify user portfolios."); return; }
  const totalOwned = (stocks[st].positions || []).reduce((a,p)=>a + (p.qty||0), 0);
  if(totalOwned < qty){ alert("Not enough shares to sell"); return; }
  if(!confirm(`Sell ${qty} √ó ${st} for ${formatR(stocks[st].price * qty)}?`)) return;

  // FIFO: remove from oldest positions first
  let remaining = qty;
  for(let i=0;i<stocks[st].positions.length && remaining>0;i++){
    const pos = stocks[st].positions[i];
    if(pos.qty <= remaining){
      remaining -= pos.qty;
      pos.qty = 0;
    } else {
      pos.qty -= remaining;
      remaining = 0;
    }
  }
  stocks[st].positions = stocks[st].positions.filter(p => p.qty > 0);
  balance += stocks[st].price * qty;
  updateBalanceUI();
  updateStockInfo(st);
  saveAll();
}

/* ---------- STOCK INFO UI ---------- */
function updateStockInfo(st){
  const s = stocks[st];
  const infoEl = document.getElementById(`info-${st}`);
  if(!infoEl) return;
  const totalOwned = (s.positions || []).reduce((acc,p)=>acc + (p.qty||0), 0);
  let html = `<strong>Current Price:</strong> ${formatR(s.price)}<br><strong>Owned (total):</strong> ${totalOwned}`;
  if(totalOwned > 0){
    html += `<div class="small-note">Positions (separate entries):</div><ul class="positions-list">`;
    s.positions.forEach((p, idx) => {
      html += `<li>Qty: ${p.qty} @ ${formatR(parseFloat(p.price))}</li>`;
    });
    html += `</ul>`;
  } else {
    html += `<div class="small-note">You do not own any shares of this company.</div>`;
  }
  infoEl.innerHTML = html;
}

/* ---------- Portfolio ---------- */
function buildPortfolioTab(){
  const port = document.getElementById("portfolio");
  let html = `<h2>üìä Portfolio</h2>`;
  html += `<table><thead><tr><th>Stock</th><th>Qty</th><th>Buy Price</th><th>Current</th><th>P/L</th></tr></thead><tbody>`;
  stockList.forEach(st => {
    const s = stocks[st];
    (s.positions || []).forEach(pos => {
      if(pos.qty > 0){
        const pl = (s.price - parseFloat(pos.price)) * pos.qty;
        const cls = pl >= 0 ? 'pl-positive' : 'pl-negative';
        html += `<tr>
          <td>${st}</td>
          <td>${pos.qty}</td>
          <td>${formatR(parseFloat(pos.price))}</td>
          <td>${formatR(s.price)}</td>
          <td class="${cls}">${formatR(pl)}</td>
        </tr>`;
      }
    });
  });
  html += `</tbody></table>`;
  port.innerHTML = html;
  document.getElementById("portfolio").style.display = "block";
}

/* ---------- DIVIDENDS (combined alert) ---------- */
function giveDividends(){
  if(!currentUser || currentUser === "admin") return;
  let totalDiv = 0;
  let breakdown = [];
  stockList.forEach(stock => {
    const s = stocks[stock];
    const owned = (s.positions || []).reduce((a,p)=>a + (p.qty||0),0);
    if(owned > 0){
      // dividend per share: min 200 + small company modifier + random
      const base = 200;
      const modifier = (stock.length % 5) * 10;
      const perShare = base + modifier + Math.floor(Math.random()*101); // 200..~400+
      const compDividend = perShare * owned;
      totalDiv += compDividend;
      breakdown.push(`${stock}: ${owned}√ó‚Çπ${perShare} = ‚Çπ${compDividend.toFixed(2)}`);
    }
  });
  if(totalDiv > 0){
    balance += totalDiv;
    alert(`üí∏ Total dividends received: ${formatR(totalDiv)}\nBreakdown:\n${breakdown.join("\n")}`);
    updateBalanceUI();
    saveAll();
  }
}

/* ---------- Random events already implemented above ---------- */

/* ---------- Balance UI ---------- */
function updateBalanceUI(){
  document.getElementById("balance").innerText = `Balance: ${formatR(balance)}`;
}

/* ---------- Save on window unload ---------- */
window.addEventListener("beforeunload", () => { saveAll(); });

/* ---------- ADMIN PANEL (powerful tools) ---------- */
function buildAdminPanel(){
  const ad = document.getElementById("adminPanel");
  let html = `<h2>‚öôÔ∏è Admin Panel</h2><div class="admin-panel-grid">`;

  // left: user list & actions
  html += `<div class="card user-list">`;
  html += `<h3 style="margin-top:0">Users</h3>`;
  for(const u in users){
    html += `<div class="user-item">
      <div>
        <div class="meta"><strong>${u}</strong></div>
        <div class="muted small-note">Balance: ${formatR(users[u].balance)}</div>
      </div>
      <div class="user-actions">
        <button class="btn btn-ghost" onclick="adminAdjustBalance('${u}')">Adjust Balance</button>
        <button class="btn btn-primary" onclick="adminEditPortfolio('${u}')">Manage Portfolio</button>
      </div>
    </div>`;
  }
  html += `</div>`;

  // right: market controls
  html += `<div class="card" style="padding:14px;">
    <h3 style="margin-top:0">Market Controls</h3>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <input id="newStockName" type="text" placeholder="New stock name" />
      <input id="newStockPrice" type="number" placeholder="Price" />
      <button class="btn btn-primary" onclick="adminAddStock()">Add Stock</button>
    </div>
    <div style="margin-top:10px;">
      <h4 style="margin:6px 0;">Existing Stocks</h4>
      <div id="admin-stock-list" style="max-height:260px; overflow:auto;"></div>
    </div>
  </div>`;

  html += `</div>`; // admin-grid
  ad.innerHTML = html;

  // populate existing stocks list
  renderAdminStockList();
  ad.style.display = "block";
}

function renderAdminStockList(){
  const el = document.getElementById("admin-stock-list");
  el.innerHTML = "";
  stockList.forEach(s => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    div.style.padding = "8px 6px";
    div.style.borderBottom = "1px solid #eef4fb";
    div.innerHTML = `<div style="font-weight:600">${s}</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="muted small-note">${formatR(stocks[s].price)}</div>
        <button class="btn btn-ghost" onclick="adminAdjustStockPrice('${s}')">Change Price</button>
        <button class="btn" style="background:${'#ef4444'}; color:white" onclick="adminRemoveStock('${s}')">Remove</button>
      </div>`;
    el.appendChild(div);
  });
}

function adminAdjustBalance(username){
  const amtStr = prompt(`Enter amount to ADD (positive) or SUBTRACT (negative) for ${username} (in ‚Çπ):`, "1000");
  if(amtStr === null) return;
  const amt = parseFloat(amtStr);
  if(isNaN(amt)){ alert("Invalid amount"); return; }
  users[username].balance = (users[username].balance || 0) + amt;
  localStorage.setItem("users", JSON.stringify(users));
  alert(`Updated ${username} balance to ${formatR(users[username].balance)}`);
  buildAdminPanel();
}

function adminEditPortfolio(username){
  // open a lightweight manage loop: show current positions, allow add/remove
  const user = users[username];
  let msg = `Manage portfolio for ${username}\n\nCurrent positions:\n`;
  const userPortfolio = user.portfolio || {};
  stockList.forEach(s => {
    const positions = (userPortfolio[s] && userPortfolio[s].positions) ? userPortfolio[s].positions : [];
    positions.forEach(p => { if(p.qty > 0) msg += `${s}: ${p.qty} @ ${formatR(p.price)}\n`; });
  });
  msg += `\nChoose an action:\n1) Add position\n2) Remove position (by stock name)\nCancel = abort`;
  const choice = prompt(msg, "1");
  if(choice === null) return;
  if(choice.trim() === "1"){
    const stockName = prompt("Stock name (existing or new):", stockList[0]);
    if(!stockName) return;
    const qty = parseInt(prompt("Qty to add:", "1"));
    const price = parseFloat(prompt("Buy price per share:", "1000"));
    if(isNaN(qty) || isNaN(price)){ alert("Invalid qty or price"); return; }
    // ensure user portfolio object
    user.portfolio = user.portfolio || {};
    if(!user.portfolio[stockName]) user.portfolio[stockName] = { price: price, positions: [], history: [] };
    user.portfolio[stockName].positions = user.portfolio[stockName].positions || [];
    user.portfolio[stockName].positions.push({ qty: qty, price: parseFloat(price) });
    // if stock not on market, add to market
    if(!stockList.includes(stockName)){
      stockList.push(stockName);
      stocks[stockName] = { price: parseFloat(price), positions: [], history: [] };
    }
    users[username] = user;
    localStorage.setItem("users", JSON.stringify(users));
    alert(`Added ${qty} x ${stockName} to ${username}`);
    buildAdminPanel();
    return;
  } else if(choice.trim() === "2"){
    const stockName = prompt("Enter stock name to remove positions from:");
    if(!stockName) return;
    if(!user.portfolio || !user.portfolio[stockName]){ alert("User has no positions in that stock"); return; }
    const remQty = parseInt(prompt("Qty to remove (will remove FIFO):", "1"));
    if(isNaN(remQty) || remQty <= 0){ alert("Invalid qty"); return; }
    // perform FIFO removal
    let remaining = remQty;
    const pos = user.portfolio[stockName].positions || [];
    for(let i=0;i<pos.length && remaining>0;i++){
      if(pos[i].qty <= remaining){ remaining -= pos[i].qty; pos[i].qty = 0; }
      else { pos[i].qty -= remaining; remaining = 0; }
    }
    user.portfolio[stockName].positions = pos.filter(p => p.qty > 0);
    users[username] = user;
    localStorage.setItem("users", JSON.stringify(users));
    alert(`Removed ${remQty - remaining} shares (attempted ${remQty}) from ${username}'s ${stockName}`);
    buildAdminPanel();
    return;
  } else {
    return;
  }
}

function adminAddStock(){
  const name = document.getElementById("newStockName").value.trim();
  const price = parseFloat(document.getElementById("newStockPrice").value || "0");
  if(!name || isNaN(price) || price <= 0){ alert("Enter valid name & price"); return; }
  if(stockList.includes(name)){ alert("Stock already exists"); return; }
  stockList.push(name);
  stocks[name] = { price: parseFloat(price), positions: [], history: [] };
  renderAdminStockList();
  loadStocksUI();
  alert(`Added ${name} at ${formatR(price)}`);
}

function adminRemoveStock(name){
  if(!confirm(`Remove ${name} from market? This will not remove users' positions in stored portfolios.`)) return;
  stockList = stockList.filter(s => s !== name);
  delete stocks[name];
  // remove DOM tab if exists
  const el = document.getElementById(name);
  if(el) el.remove();
  renderAdminStockList();
  loadStocksUI();
  alert(`${name} removed from market.`);
}

function adminAdjustStockPrice(name){
  const amtStr = prompt(`Set new price for ${name} (enter numeric) ‚Äî or prefix + or - to change relative:`, `${stocks[name].price.toFixed(2)}`);
  if(amtStr === null) return;
  let val = amtStr.trim();
  if(val.startsWith("+") || val.startsWith("-")){
    const delta = parseFloat(val);
    if(isNaN(delta)){ alert("Invalid change"); return; }
    stocks[name].price = Math.max(1, stocks[name].price + delta);
  } else {
    const p = parseFloat(val);
    if(isNaN(p) || p <= 0){ alert("Invalid price"); return; }
    stocks[name].price = p;
  }
  renderAdminStockList();
  // update UI price elements and charts
  const priceEl = document.getElementById(`price-${name}`);
  if(priceEl) priceEl.innerText = formatR(stocks[name].price);
  updateStockInfo(name);
  saveAll();
  alert(`Updated ${name} price to ${formatR(stocks[name].price)}`);
}

/* ---------- Initialization on page load ---------- */
window.onload = () => {
  // ensure there is at least one default admin user in storage for demo
  if(!users["alice"]) {
    // optional sample user so admin panel isn't empty
    users["alice"] = { password: "alice", balance: 10000, portfolio: {} };
    localStorage.setItem("users", JSON.stringify(users));
  }
  // Pre-populate stocks if user portfolio empty and not logged in yet
  stockList.forEach(s => {
    if(!stocks[s]) stocks[s] = { price: 1000 + Math.random()*200, positions: [], history: [] };
  });
};
</script>
</body>
</html>
