<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>InvestoPlay</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9fafc; margin: 0; }
    header { background: linear-gradient(90deg, #007bff, #00b4d8); color: #fff; padding: 20px; text-align: center; font-size: 26px; font-weight: bold; }
    nav { display: flex; justify-content: center; flex-wrap: wrap; background: #fff; padding: 12px; border-bottom: 1px solid #ddd; }
    nav button { margin: 6px; padding: 10px 18px; border: none; border-radius: 6px; background: #007bff; color: #fff; cursor: pointer; font-weight: 500; }
    nav button:hover { background: #0056b3; }
    .tab { display: none; padding: 20px; background: #fff; margin: 20px auto; border-radius: 10px; max-width: 850px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { color: #007bff; }
    .stockInfo { margin-top: 15px; padding: 12px; background: #f1f5f9; border-radius: 6px; border: 1px solid #e2e8f0; }
    .stockActions { margin-top: 12px; }
    .stockActions input { width: 60px; padding: 6px; margin-right: 10px; text-align: center; border-radius: 6px; border: 1px solid #ccc; }
    .stockActions button { padding: 10px 16px; border: none; border-radius: 6px; color: #fff; margin-right: 10px; font-weight: bold; cursor: pointer; }
    .stockActions button:first-of-type { background: #28a745; }
    .stockActions .sell { background: #dc3545; }
    #balance { font-size: 20px; font-weight: bold; text-align: center; }
    #loginSection { max-width: 400px; margin: 60px auto; background: #fff; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input { padding: 10px; margin: 8px auto; border: 1px solid #ccc; border-radius: 6px; }
    #loginSection button { width: 40%; margin: 8px; padding: 10px; border: none; border-radius: 6px; background: #007bff; color: #fff; font-weight: 600; cursor: pointer; }
    #loginSection button:hover { background: #0056b3; }
    #adminPanel { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    .small-note { font-size: 13px; color:#555; margin-top:8px; }
  </style>
</head>
<body>
  <header>üìà InvestoPlay ‚Äî Dummy Investment Simulator</header>

  <div id="loginSection">
    <h2>Login / Signup</h2>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="signup()">Signup</button>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <div id="appSection" style="display:none;">
    <nav id="stockTabs"></nav>
    <p id="balance">Balance: ‚Çπ10000</p>
    <div id="stockContainers"></div>
    <div id="portfolio" class="tab"></div>
    <div id="adminPanel" class="tab"></div>
  </div>

<script>
let users = JSON.parse(localStorage.getItem("users")) || {};
let currentUser = null, balance = 10000, stocks = {}, charts = {};
const stockList = [
  "TechNova","GreenEnergy","FoodiesHub","AeroMax","CryptoWave",
  "HealthFirst","EduGrow","GameX","RoboWorks","AutoDrive",
  "FashionFi","BuildPro"];
let newsHeadlines = ["launches new product","faces regulations","profits surge","merger rumors","stock buyback announced"];

// Signup
function signup(){
  let u=document.getElementById("username").value, p=document.getElementById("password").value;
  if(!u||!p) return alert("Enter username & password!");
  if(users[u]) return alert("User exists!");
  users[u]={password:p,balance:10000,portfolio:{}};
  localStorage.setItem("users",JSON.stringify(users));
  alert("Signup successful!");
}

// Login
function login(){
  let u=document.getElementById("username").value, p=document.getElementById("password").value;
  if(u==="admin" && p==="admin123"){ currentUser="admin"; document.getElementById("loginSection").style.display="none"; document.getElementById("appSection").style.display="block"; loadStocks(); showAdminPanel(); return; }
  if(users[u] && users[u].password===p){ currentUser=u; balance=users[u].balance; stocks=users[u].portfolio||{}; document.getElementById("loginSection").style.display="none"; document.getElementById("appSection").style.display="block"; loadStocks(); updateBalance(); }
  else document.getElementById("loginMsg").innerText="Invalid login!";
}

// Load Stocks UI
function loadStocks(){
  let tabs=document.getElementById("stockTabs"), cont=document.getElementById("stockContainers");
  tabs.innerHTML=""; cont.innerHTML="";
  let portBtn=document.createElement("button"); portBtn.innerText="üìä Portfolio"; portBtn.onclick=()=>showTab("portfolio"); tabs.appendChild(portBtn);
  if(currentUser==="admin"){ let adBtn=document.createElement("button"); adBtn.innerText="‚öôÔ∏è Admin Panel"; adBtn.onclick=()=>showTab("adminPanel"); tabs.appendChild(adBtn); }
  stockList.forEach(st=>{
    let btn=document.createElement("button"); btn.innerText=st; btn.onclick=()=>showTab(st); tabs.appendChild(btn);
    let div=document.createElement("div"); div.id=st; div.className="tab"; 
    div.innerHTML=`
      <h2>${st}</h2>
      <canvas id="chart-${st}"></canvas>
      <div class="stockInfo" id="info-${st}"></div>
      <div class="stockActions">
        <input type="number" id="qty-${st}" min="1" value="1">
        <button onclick="buyStock('${st}')">Buy</button>
        <button class="sell" onclick="sellStock('${st}')">Sell</button>
      </div>
      <p id="news-${st}"></p>`;
    cont.appendChild(div);

    // initialize stock structure with positions array (keep previously-stored data compatible)
    if(!stocks[st]) stocks[st]={ price:1000+Math.random()*200, positions:[], history:[] };
    else {
      // If older data uses 'owned' and 'buyPrice', convert to positions (backwards-compat)
      if(typeof stocks[st].owned !== "undefined" && stocks[st].owned>0) {
        let qty = stocks[st].owned || 0;
        let bp = stocks[st].buyPrice || stocks[st].buyPrice===0 ? stocks[st].buyPrice : stocks[st].price;
        stocks[st].positions = stocks[st].positions || [];
        if(qty>0) stocks[st].positions.push({ qty: qty, price: parseFloat(bp) });
        delete stocks[st].owned;
        delete stocks[st].buyPrice;
      }
      stocks[st].positions = stocks[st].positions || [];
      stocks[st].price = stocks[st].price || (1000+Math.random()*200);
      stocks[st].history = stocks[st].history || [];
    }

    let ctx=div.querySelector(`#chart-${st}`);
    charts[st]=new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:st,data:[],borderColor:"#007bff",fill:false}]},options:{scales:{y:{beginAtZero:false}}}});
  });
  showTab(stockList[0]);
  setInterval(updatePrices,5000);
  setInterval(randomEvents,7000);
  setInterval(giveDividends,15000); // dividends every 15 sec
}

// Show tab
function showTab(tab){ 
  document.querySelectorAll(".tab").forEach(t=>t.style.display="none"); 
  let el = document.getElementById(tab);
  if(!el) return;
  el.style.display="block"; 
  if(tab==="portfolio") showPortfolio(); 
  else if(tab==="adminPanel") showAdminPanel(); 
  else updateStockInfo(tab); 
}

// Update prices
function updatePrices(){
  stockList.forEach(st=>{
    let ch=(Math.random()-0.5)*100; 
    stocks[st].price=Math.max(100,stocks[st].price+ch); 
    stocks[st].history.push(stocks[st].price.toFixed(2)); 
    if(stocks[st].history.length>20) stocks[st].history.shift();
    let chart=charts[st]; 
    chart.data.labels=Array(stocks[st].history.length).fill(""); 
    chart.data.datasets[0].data=stocks[st].history; 
    chart.data.datasets[0].borderColor=(ch>=0?"green":"red"); 
    chart.update();
    updateStockInfo(st);
  }); 
  saveData();
}

// Update info
function updateBalance(){ document.getElementById("balance").innerText=`Balance: ‚Çπ${balance.toFixed(2)}`; }
function updateStockInfo(st){
  let s=stocks[st];
  // compute total owned from positions
  let totalOwned = s.positions.reduce((acc,p)=>acc + (p.qty||0), 0);
  let inf = `Current Price: ‚Çπ${s.price.toFixed(2)}<br>Owned (total): ${totalOwned}`;
  if(totalOwned>0){
    // list positions (separate entries)
    inf += `<div class="small-note">Positions:</div><ul>`;
    s.positions.forEach((p,idx) => {
      inf += `<li>Qty: ${p.qty} @ ‚Çπ${parseFloat(p.price).toFixed(2)}</li>`;
    });
    inf += `</ul>`;
  }
  document.getElementById(`info-${st}`).innerHTML=inf;
  document.getElementById(`news-${st}`).innerText=`${st} ${newsHeadlines[Math.floor(Math.random()*newsHeadlines.length)]}`;
}

// Buy/Sell with quantity (positions kept separate)
function buyStock(st){
  let qty=parseInt(document.getElementById(`qty-${st}`).value)||1;
  let s=stocks[st], totalCost=s.price*qty;
  if(balance<totalCost) return alert("Not enough money!");
  if(confirm(`Buy ${qty} shares of ${st} for ‚Çπ${totalCost.toFixed(2)}?`)){
    balance-=totalCost;
    // push a separate position (keeps original buy price)
    s.positions.push({ qty: qty, price: parseFloat(s.price.toFixed(2)) });
    updateBalance(); updateStockInfo(st); saveData();
  }
}

function sellStock(st){
  let qty=parseInt(document.getElementById(`qty-${st}`).value)||1;
  let s=stocks[st];
  let totalOwned = s.positions.reduce((acc,p)=>acc + (p.qty||0), 0);
  if(totalOwned<qty) return alert("You don't own enough shares!");
  if(confirm(`Sell ${qty} shares of ${st} for ‚Çπ${(s.price*qty).toFixed(2)}?`)){
    // FIFO: reduce from earliest positions first
    let remaining = qty;
    for(let i=0;i<s.positions.length && remaining>0;i++){
      let pos = s.positions[i];
      if(pos.qty <= remaining){
        remaining -= pos.qty;
        pos.qty = 0;
      } else {
        pos.qty -= remaining;
        remaining = 0;
      }
    }
    // remove zero-qty positions
    s.positions = s.positions.filter(p => p.qty > 0);
    balance += s.price * qty;
    updateBalance(); updateStockInfo(st); saveData();
  }
}

// ‚úÖ Portfolio - now lists each position separately (no averaging)
function showPortfolio(){ 
  let port=document.getElementById("portfolio"); 
  let html="<h2>üìä Your Portfolio</h2><table><tr><th>Stock</th><th>Qty</th><th>Buy Price</th><th>Current Price</th><th>P/L (this position)</th></tr>"; 
  stockList.forEach(st=>{ 
    let s=stocks[st]; 
    // list each position separately
    s.positions.forEach(pos => {
      if(pos.qty>0){
        let pl = (s.price - parseFloat(pos.price)) * pos.qty;
        html+=`<tr><td>${st}</td><td>${pos.qty}</td><td>‚Çπ${parseFloat(pos.price).toFixed(2)}</td><td>‚Çπ${s.price.toFixed(2)}</td><td style="color:${pl>=0?"green":"red"}">‚Çπ${pl.toFixed(2)}</td></tr>`;
      }
    });
  }); 
  html+="</table>"; 
  port.innerHTML=html; 
}

// Admin Panel
function showAdminPanel(){ let ad=document.getElementById("adminPanel"); let html="<h2>‚öôÔ∏è Admin Panel</h2><table><tr><th>User</th><th>Balance</th><th>Actions</th></tr>"; for(let u in users){ html+=`<tr><td>${u}</td><td>‚Çπ${users[u].balance}</td><td><button onclick="giveMoney('${u}')">+‚Çπ1000</button></td></tr>`; } html+="</table>"; ad.innerHTML=html; }
function giveMoney(u){ users[u].balance+=1000; localStorage.setItem("users",JSON.stringify(users)); alert(`${u} credited ‚Çπ1000!`); showAdminPanel(); }

// Events & Dividends
function randomEvents(){ if(Math.random()<0.3){ let st=stockList[Math.floor(Math.random()*stockList.length)]; let boom=Math.random()<0.5; stocks[st].price*=boom?1.3:0.7; alert(boom?`üöÄ ${st} skyrocketed!`:`‚ö†Ô∏è ${st} crashed!`); } }

// ‚úÖ Dividends: per-share based, combined alert
function giveDividends() {
  if (!currentUser || currentUser === "admin") return;

  let totalDividend = 0;
  let breakdown = [];

  stockList.forEach(stock => {
    let s = stocks[stock];
    // count shares owned
    let totalOwned = s.positions.reduce((acc,p)=>acc + (p.qty||0), 0);
    if (totalOwned > 0) {
      // dividend per share depends on company and a random factor (but at least 200 per share)
      // you asked for "based on number of stocks i have or the specific company" ‚Äî so dividend_per_share = base + randomness
      let base = 200; // minimum
      // small company-specific modifier to make things varied:
      let companyModifier = (stock.length % 5) * 10; // deterministic small modifier
      let perShare = base + companyModifier + Math.floor(Math.random()*101); // 200..~400+mod
      // dividend for this company = perShare * totalOwned
      let companyDividend = perShare * totalOwned;
      totalDividend += companyDividend;
      breakdown.push(`${stock}: ${totalOwned}√ó‚Çπ${perShare} = ‚Çπ${companyDividend.toFixed(2)}`);
    }
  });

  if (totalDividend > 0) {
    balance += totalDividend;
    // Single combined alert, with a compact breakdown
    let msg = `üí∏ Total dividends received: ‚Çπ${totalDividend.toFixed(2)}\nBreakdown:\n${breakdown.join("\n")}`;
    alert(msg);
    updateBalance();
    saveData();
  }
}

// Save
function saveData(){ 
  if(currentUser && currentUser !== "admin"){ 
    users[currentUser].balance=balance; 
    users[currentUser].portfolio=stocks; 
    localStorage.setItem("users",JSON.stringify(users)); 
  } 
}
</script>
</body>
</html>
